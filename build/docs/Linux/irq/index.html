<!doctype html>
<html lang="ljyws" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Linux/irq/irq" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">Linux 中断 | Hello!</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ljyws.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ljyws.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ljyws.com/docs/Linux/irq/"><meta data-rh="true" property="og:locale" content="ljyws"><meta data-rh="true" name="docusaurus_locale" content="ljyws"><meta data-rh="true" name="docsearch:language" content="ljyws"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Linux 中断 | Hello!"><meta data-rh="true" name="description" content="中断"><meta data-rh="true" property="og:description" content="中断"><link data-rh="true" rel="icon" href="/img/sheep.ico"><link data-rh="true" rel="canonical" href="https://ljyws.com/docs/Linux/irq/"><link data-rh="true" rel="alternate" href="https://ljyws.com/docs/Linux/irq/" hreflang="ljyws"><link data-rh="true" rel="alternate" href="https://ljyws.com/docs/Linux/irq/" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script src="src/custom-script.js" async></script><link rel="stylesheet" href="/assets/css/styles.0ace63c3.css">
<script src="/assets/js/runtime~main.0cf0e045.js" defer="defer"></script>
<script src="/assets/js/main.8061b472.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_vL3y" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/home_logo.svg" alt="My Site Logo" class="themedComponent_yNzQ themedComponent--light_XB7g"><img src="/img/home_logo.svg" alt="My Site Logo" class="themedComponent_yNzQ themedComponent--dark_Ih68"></div><b class="navbar__title text--truncate">HOME</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">BLOG</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ljyws" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_vnGv"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_p3ST"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_nWpo"><div class="docsWrapper_S7Ws"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ILib" type="button"></button><div class="docRoot_y1tR"><aside class="theme-doc-sidebar-container docSidebarContainer_Nn1g"><div class="sidebarViewport_GazN"><div class="sidebar_ys6v"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_FFtM"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">主页</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/ProgrammingTips/finite-state machine/fsm">ProgrammingTips</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/StepperCtrl/simulation">StepperFocCtrl</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/FocController/foc_controller">FocController</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/quadruped-sim/eigen/">Quadruped-sim</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/Linux/Imx6ull/imx6ull_uboot_kernel/">Linux</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Linux/Imx6ull/imx6ull_uboot_kernel/">Imx6ull</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Linux/irq/">Linux IRQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Linux/CPU Context/cou_context">CPU Context</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Linux/vmm/">vmm</a></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_DINd"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_uqYz"><div class="docItemContainer_i0hV"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_tQkO" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_zh8J"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Linux</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Linux IRQ</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_yfiv theme-doc-toc-mobile tocMobile_gZBm"><button type="button" class="clean-btn tocCollapsibleButton_ntcz">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Linux 中断</h1></header><h2 class="anchor anchorWithStickyNavbar_WC8U" id="中断">中断<a href="#中断" class="hash-link" aria-label="Direct link to 中断" title="Direct link to 中断">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="几个概念">几个概念<a href="#几个概念" class="hash-link" aria-label="Direct link to 几个概念" title="Direct link to 几个概念">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="11-中断机制的目的和作用">1.1 中断机制的目的和作用<a href="#11-中断机制的目的和作用" class="hash-link" aria-label="Direct link to 1.1 中断机制的目的和作用" title="Direct link to 1.1 中断机制的目的和作用">​</a></h4>
<ul>
<li>外设异步通知CPU，比如定时器时间到、 或者收到一帧什么消息</li>
<li>CPU之间，在多CPU系统，一个CPU要给另一个CPU发消息，可以发送IPI也就是处理器间的中断</li>
<li>处理CPU异常，异常中断</li>
<li>早期系统调用是靠中断指令来实现</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="12-中断产生来源">1.2 中断产生来源<a href="#12-中断产生来源" class="hash-link" aria-label="Direct link to 1.2 中断产生来源" title="Direct link to 1.2 中断产生来源">​</a></h4>
<ul>
<li>外设，外设产生的中断信号是异步的，一般也叫硬件中断</li>
<li>CPU，是指一个CPU给另一个CPU发送IPI，这种中断叫处理期间中断</li>
<li>CPU异常，一般CPU把自己的异常按照能不能修复，分为三种异常，1.塌陷(trap)，不需要修复，中断处理完后执行下一条指令，2.故障，需要修复也可能修复，中断处理完后重新执行之前的指令，3。 中止，需要修复，但无法修复，中断处理完后内核会崩溃，比如缺页异常</li>
<li>中断指令，直接用CPU来产生中断信号。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="13-中断的处理">1.3 中断的处理<a href="#13-中断的处理" class="hash-link" aria-label="Direct link to 1.3 中断的处理" title="Direct link to 1.3 中断的处理">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_WC8U" id="a-执行场景">a) 执行场景<a href="#a-执行场景" class="hash-link" aria-label="Direct link to a) 执行场景" title="Direct link to a) 执行场景">​</a></h5>
<p>在中断产生之间，是没有这个概念的，有了中断后，将CPU分为了两个执行场景，为<strong>进程执行场景</strong> 和 <strong>中断执行场景</strong>，进程的执行是进程执行场景，同步中断的处理也是进程执行场景，异步中断的处理是中断处理场景。理解为因为同步中断处理是当前指令触发的，可以看作是进程的一部分，而异步中断的处理和当前指令无关。</p>
<ul>
<li>进程执行场景可以调度，可以休眠，而中断执行场景无法调度也无法休眠</li>
<li>在进程执行场景中可以接受中断信号，但在中断执行场景是屏蔽了中断信号的，所以如果中断执行场景的时间太长，会影响对新中断的信号的响应性，所以应尽可能的缩短中断执行场景，那么对异步的中断处理有几种方法：</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_WC8U" id="1-立即完全处理">1. 立即完全处理<a href="#1-立即完全处理" class="hash-link" aria-label="Direct link to 1. 立即完全处理" title="Direct link to 1. 立即完全处理">​</a></h6>
<p>对简单的异步中断完全处理</p>
<h6 class="anchor anchorWithStickyNavbar_WC8U" id="2-立即预处理稍后完全处理">2. 立即预处理+稍后完全处理<a href="#2-立即预处理稍后完全处理" class="hash-link" aria-label="Direct link to 2. 立即  预处理+稍后完全处理" title="Direct link to 2. 立即预处理+稍后完全处理">​</a></h6>
<p>对于处理起来比较费时间的采取立即预处理加稍后完全处理，其实后者就是线程中断化，在linux中，中断预处理部分叫做上半部，中断后处理叫做下半部。</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="14-中断向量号">1.4 中断向量号<a href="#14-中断向量号" class="hash-link" aria-label="Direct link to 1.4 中断向量号" title="Direct link to 1.4 中断向量号">​</a></h4>
<p>不同的中断信号需要有不同的处理方式，所以需要靠中断向量号来区分，每一个中断信号都有一个中断向量号，中断向量号是一个整数，CPU收到中断信号后会根据信号的中断向量去查询中断向量表，根据向量表里去调用相应的中断处理函数。</p>
<p>特别的，对于CPU异常中断，其向量号是由架构规定的，而对于外设来说，是由设备驱动动态申请的。</p>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="arm下中断">arm下中断<a href="#arm下中断" class="hash-link" aria-label="Direct link to arm下中断" title="Direct link to arm下中断">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="21-中断控制器">2.1 中断控制器<a href="#21-中断控制器" class="hash-link" aria-label="Direct link to 2.1 中断控制器" title="Direct link to 2.1 中断控制器">​</a></h4>
<p>ARM下提供了一个通用的中断控制器为GIC,主要是接受中断信号，处理后分发给CPU处理。以GIC v3版本为例，</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="211-gic中断类型">2.1.1 GIC中断类型<a href="#211-gic中断类型" class="hash-link" aria-label="Direct link to 2.1.1 GIC中断类型" title="Direct link to 2.1.1 GIC中断类型">​</a></h4>
<ul>
<li>SGI：软件触发的中断，软件可以通过写GICD_SGIR寄存器，来触发中断，一般用于核之间通信，内核中的IPI就是基于SGI。</li>
<li>PPI：  私有外设中断，这是每个核心私有的中断，PPI会送到指定的CPU上</li>
<li>SPI：公用的外部设备中断，也叫共享中断</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="212-gic中断组成">2.1.2 GIC中断组成<a href="#212-gic中断组成" class="hash-link" aria-label="Direct link to 2.1.2 GIC中断组成" title="Direct link to 2.1.2 GIC中断组成">​</a></h4>
<ul>
<li>Distributor<!-- -->:spi<!-- -->的中断管理，将中断发送给Redistributor</li>
</ul>
<ol>
<li>
<p>打开或关闭每个中断，Distributor对中断的控制分成了两级，一个是全局中断的控制(GIC_DIST_CTRL),一旦关闭全局中断，那么任何中断源的中断事件都并不会被传递给CPU，另一个是针对各个中断源的控制，(GIC_DIST_ENABLE_CLEAR),关闭某某一个只会导致某中断事件不会分发到CPU。</p>
</li>
<li>
<p>控制将当前优先级最高的中断事件分发到一个或者一组CPU，当一个中断事件分发到多个CPU的时候，GIC内部逻辑应该保证只发给一个CPU</p>
</li>
<li>
<p>优先级控制</p>
</li>
<li>
<p>interrupt属性设定，设置每个外设的触发方式</p>
</li>
<li>
<p>interrupt group设定，设置每个中断组，其中group0用于安全中断，支持快速中断请求FIQ和一般中断请求IRQ,group1用于非安全中断，只支持IRQ</p>
</li>
</ol>
<ul>
<li>Redistributor:</li>
</ul>
<ol>
<li>启用和禁用SGI和PPI</li>
<li>设置SGI和PPI的优先级</li>
<li>将每个PPI设置为电平触发或边缘触发</li>
<li>将每个SGI和PPI分配给中断组</li>
<li>控制SGI和PPI状态</li>
<li>内存中数据结构和基地址控制，支持LPI的相关中断属性和挂起状态</li>
<li>电源管理支持</li>
</ol>
<ul>
<li>CPU interface 传输中断给核</li>
</ul>
<ol>
<li>
<p>打开或关闭CPU interface向连接的CPU assert事件，对于ARM,CPU interface和cpu之间的中断信号线是nIRQCPU和nFIQCPU,如果关了中断，即便Distributor分发了一个中断事件到了CPU interface，也不会assert指定的核</p>
</li>
<li>
<p>中断的确认。核会向CPU interface应答中断，中断一旦被应答，Distribetor就会把该中断的状态从pending修改成active，或者pending and active，应答中断后，cpu interface就会deassert nIRQCPU和nFIQCPU信号线</p>
</li>
<li>
<p>中断处理完毕的通知，当interrupt handler处理完一个函数后，会向CPU INTERFACE的寄存器通知GIC，CPU已经处理完了该中断，这个动作一方面是通知Distributor将中断状态改为deactive，另外一方面，CPU interface 会 priority drop，从而允许其他的 pending 的中断向 CPU 提交</p>
</li>
<li>
<p>为 CPU 设置中断优先级掩码。通过 priority mask，可以 mask 掉一些优先级比较低的中断，这些中断不会通知到 CPU</p>
</li>
<li>
<p>设置 CPU 的中断抢占（preemption）策略。</p>
</li>
<li>
<p>在多个中断事件同时到来的时候，选择一个优先级最高的通知 CPU</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="213-中断路由">2.1.3 中断路由<a href="#213-中断路由" class="hash-link" aria-label="Direct link to 2.1.3 中断路由" title="Direct link to 2.1.3 中断路由">​</a></h4>
<p>GIC v3使用一个hierarchy来标识一个具体的core</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="214-中断状态机">2.1.4 中断状态机<a href="#214-中断状态机" class="hash-link" aria-label="Direct link to 2.1.4 中断状态机" title="Direct link to 2.1.4 中断状态机">​</a></h4>
<p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/1-939c4630dd94bd30b767e24531527053.png" width="934" height="532" class="img_PzW8"></p>
<ul>
<li>Inactive:无中断状态，即没有pending也没有actice</li>
<li>pending:由硬件或软件触发了中断，该中断事件已经通过硬件信号通知到了GIC，等待GIC分配到CPU处理</li>
<li>active<!-- -->:CPU<!-- -->已经应答了中断请求，在处理中</li>
<li>active and pending：当一个中断源处于active状态，同一中断源又触发了中断，进入pending状态</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="215-中断处理流程">2.1.5 中断处理流程<a href="#215-中断处理流程" class="hash-link" aria-label="Direct link to 2.1.5 中断处理流程" title="Direct link to 2.1.5 中断处理流程">​</a></h4>
<ol>
<li>外设发起中断，发送给Distributor</li>
<li>Distributor将该中断发给相应的Redistributor</li>
<li>Redistributor将该中断信息发送给CPU interface</li>
<li>CPU interface产生相应的中断信号给处理器</li>
<li>处理器接受中断信号，处理中断处理函数</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="gic控制器中断流程">GIC控制器中断流程<a href="#gic控制器中断流程" class="hash-link" aria-label="Direct link to GIC控制器中断流程" title="Direct link to GIC控制器中断流程">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="31-中断注册">3.1 中断注册<a href="#31-中断注册" class="hash-link" aria-label="Direct link to 3.1 中断注册" title="Direct link to 3.1 中断注册">​</a></h4>
<p>设备驱动中，获取到了IRQ的中断号后，通常使用request_irq/request_threaded_irq 来注册中断，其中前者用于注册普通的中断，后者用于注册线程化处理中断，而线程化中断主要是把中断上下文的任务搬到线程中，减少系统关中断事件。增强系统实时性。</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="32-中断的处理">3.2 中断的处理<a href="#32-中断的处理" class="hash-link" aria-label="Direct link to 3.2 中断的处理" title="Direct link to 3.2 中断的处理">​</a></h4>
<p>当完成中断注册后，剩下就是等待中断信号的来临。
在ARM架构中，EL0是ARMv8-A架构中定义的四个异常等级（Exception Levels）之一，被称为无特权执行级别。在这个级别上运行的是普通的用户应用程序
。EL0是最低的异常级别，通常用于执行用户态的代码，这些代码没有特权去访问或修改关键的系统资源或配置
。在ARMv8架构中，随着异常等级编号的增加，软件的执行权限也相应增加，EL0作为最低等级，拥有的权限也最少
。在ARM架构中，EL0和EL1是必须实现的，而EL2和EL3是可选的。</p>
<p>此时假设在当前EL0运行一个APP，触发了一个EL0的IRQ中断，则处理器会先跳转到arm对应的异常向量表，以arm-64为例，</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Exception vectors.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pushsection &quot;.entry.text&quot;, &quot;ax&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .align  11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYM_CODE_START(vectors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   1, sync                         // el1 下的同步异常，例如指令执行异常、缺页中断等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   1, irq                          // el1 下的异步异常，硬件中断。1代表异常等级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   1, fiq_invalid                  // FIQ EL1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   1, error                        // Error EL1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   0, sync                         // el0 下的同步异常，例如指令执行异常、缺页中断（跳转地址或者取地址）、系统调用等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   0, irq                          // el0 下的异步异常，硬件中断。0代表异常等级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   0, fiq_invalid                  // FIQ 64-bit EL0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kernel_ventry   0, error                        // Error 64-bit EL0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYM_CODE_END(vectors)</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上面的异常向量表中，设置了 各种异常的入口，kernel_ventry展开后，可以看到有效的异常入口又两个同步异常el0_sync,和el1_sync和两个异步异常el0_irq和el1_irq。
<img decoding="async" loading="lazy" alt="alt text" src="/assets/images/2-9f9fae659fa53b61d04c1c525793cda3.png" width="1177" height="824" class="img_PzW8">
可以看到中断处理分为三部分:保护现场，中断处理，恢复现场。以el0_irq为例：</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="33-保护现场">3.3 保护现场<a href="#33-保护现场" class="hash-link" aria-label="Direct link to 3.3 保护现场" title="Direct link to 3.3 保护现场">​</a></h4>
<p>kernel_entry 0，其中 kernel_entry 是一个宏，此宏会将 CPU 寄存器按照 pt_regs 结构体的定义将第一现场保存到栈上。</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">.macro  kernel_entry, el, regsize = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.if     \regsize == 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov     w0, w0                          // zero upper 32 bits of x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x0, x1, [sp, #16 * 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x2, x3, [sp, #16 * 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x4, x5, [sp, #16 * 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x6, x7, [sp, #16 * 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x8, x9, [sp, #16 * 4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x10, x11, [sp, #16 * 5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x12, x13, [sp, #16 * 6]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x14, x15, [sp, #16 * 7]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x16, x17, [sp, #16 * 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x18, x19, [sp, #16 * 9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x20, x21, [sp, #16 * 10]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x22, x23, [sp, #16 * 11]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x24, x25, [sp, #16 * 12]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x26, x27, [sp, #16 * 13]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stp     x28, x29, [sp, #16 * 14]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.if     \el == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clear_gp_regs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrs     x21, sp_el0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ldr_this_cpu    tsk, __entry_task, x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msr     sp_el0, tsk</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中enable_da_f是关闭中断，保护现场主要的工作就是：</p>
<ol>
<li>保存PSTATE到SPSR_ELx寄存器</li>
<li>将PSTATE的DAIF全部平壁</li>
<li>保存PC寄存器的值到ELR_ELx寄存器</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="34-中断处理">3.4 中断处理<a href="#34-中断处理" class="hash-link" aria-label="Direct link to 3.4 中断处理" title="Direct link to 3.4 中断处理">​</a></h4>
<p>保护过现场后，会跳入irq_handler</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Interrupt handling.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .macro  irq_handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ldr_l   x1, handle_arch_irq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mov     x0, sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irq_stack_entry      //进入中断栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blr     x1           //执行 handle_arch_irq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irq_stack_exit       //退出中断栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .endm</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里主要做了三个动作：</p>
<ol>
<li>进入中断栈</li>
<li>执行中断控制的handle_arch-irq</li>
<li>退出中断栈</li>
</ol>
<p>中断栈用来保存中断上下文，中断发生和退出的时候调用irq_stack_entry和irq_stack_exit来进入和退出中断栈，中断栈是内核启动的时候创建的，内核在启动的时候会给每个CPU创建一个per cpu的中断栈，也就是执行顺序：start_kernel-&gt;init_IRQ-&gt;init_irq_stacks.</p>
<p>那么handle_arch_irq又指向哪里？
在内核启动过程中初始化gic控制，会设置具体的handler，gic_init_bases-&gt;set_handle_irq将handle_arch_irq指向了gic_handle_irq函数，所以最终会进入gic_handle_irq，在这个函数里：</p>
<ol>
<li>读取GICC_IAR寄存器，获取hwirq</li>
<li>外设触发的中断，硬件中断号 0-15 表示 SGI 类型的中断，15-1020 表示外设中断（SPI或PPI类型），8192-MAX 表示 LPI 类型的中断</li>
<li>中断控制器的中断处理主体</li>
<li>软件触发的中断</li>
<li>核间交互触发的中断</li>
</ol>
<p>其中中断控制器处理主体：</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">int __handle_domain_irq(struct irq_domain *domain, unsigned int hwirq,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   bool lookup, struct pt_regs *regs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> struct pt_regs *old_regs = set_irq_regs(regs);        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> unsigned int irq = hwirq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> irq_enter();                               ------(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_IRQ_DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> if (lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  irq = irq_find_mapping(domain, hwirq);    ------(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Some hardware gives randomly wrong interrupts.  Rather</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * than crashing, do something sensible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> if (unlikely(!irq || irq &gt;= nr_irqs)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ack_bad_irq(irq);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ret = -EINVAL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  generic_handle_irq(irq);                  ------(3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> irq_exit();                                ------(4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> set_irq_regs(old_regs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>irq_enter();  进入中断上下文</li>
<li>irq = irq_find_mapping(domain, hwirq);根据hwirq来查找linux中断号</li>
<li>generic_handle_irq(irq);  也就是</li>
</ol>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">static inline void generic_handle_irq_desc(struct irq_desc *desc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> desc-&gt;handle_irq(desc);            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过中断号找到全局中断描述符数组irq_desc[NR_IRQS]，然后调用该中断的action函数
4. irq_exit();  退出中断上下文</p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="35-恢复现场">3.5 恢复现场<a href="#35-恢复现场" class="hash-link" aria-label="Direct link to 3.5 恢复现场" title="Direct link to 3.5 恢复现场">​</a></h4>
<ol>
<li>disable中断</li>
<li>检查在退出前有没有需要处理的事情</li>
<li>将一开始压栈的pt_regs弹出，恢复现场</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_WC8U" id="linux中的中断api函数">Linux中的中断API函数<a href="#linux中的中断api函数" class="hash-link" aria-label="Direct link to Linux中的中断API函数" title="Direct link to Linux中的中断API函数">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="一中断号">一、中断号<a href="#一中断号" class="hash-link" aria-label="Direct link to 一、中断号" title="Direct link to 一、中断号">​</a></h3>
<p>在linux中，使用一个int变量表示中断号其中有：</p>
<ul>
<li>私有外设中断(PPI):中断号为16-31</li>
<li>共享外设中断(SPI):中断号为32-1020，对于imx6ull，实际支持的SPI中断号有128个，也就是ID为32-159</li>
<li>软件中断(SGI):通常为0-15</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="二request_irq函数">二、request_irq函数<a href="#二request_irq函数" class="hash-link" aria-label="Direct link to 二、request_irq函数" title="Direct link to 二、request_irq函数">​</a></h3>
<p>在liunx中，要使用某个中断是需要申请的，使用request_irq函数用于申请中断，但是这个函数可能会导致睡眠，因此不能在中断上下文或者其他禁止睡眠的位置使用request_irq函数，函数原型：</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">int request_irq(unsigned int irq,     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                irq_handler_t handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                unsigned long  flags,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                const char *name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                void    *dev) </span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中：</p>
<ul>
<li>irq:要申请的中断号</li>
<li>handler:中断处理函数</li>
<li>flags:中断标志，都定义在include/linux/interrupt.h里，一些常用的有：</li>
</ul>
<table><thead><tr><th style="text-align:left">FLAG</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">IRQF_SHARE</td><td style="text-align:left">多个设备共享一个中断号的时候，共享的所有中断都指定这个中断标志，并使用request_irq里的dev参数来区分</td></tr><tr><td style="text-align:left">IRQF_ONESHOT</td><td style="text-align:left">单次中断，只执行一次</td></tr><tr><td style="text-align:left">IRQF_TRIGGER_NON</td><td style="text-align:left">无触发</td></tr><tr><td style="text-align:left">IRQF_TRIGGER_RISING</td><td style="text-align:left">上升沿触发</td></tr><tr><td style="text-align:left">IRQF_TRIGGER_FALLING</td><td style="text-align:left">下降沿触发</td></tr><tr><td style="text-align:left">IRQF_TRIGGER_HIGH</td><td style="text-align:left">高电平触发</td></tr><tr><td style="text-align:left">IRQF_TRIGGER_LOW</td><td style="text-align:left">低电平触发</td></tr></tbody></table>
<ul>
<li>name:中断名字，设置后可以在/proc/interrupts文件里看到</li>
<li>dev:为设备结构体，会传递到irq_handler_t的第二个参数</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="三free_irq函数">三、free_irq函数<a href="#三free_irq函数" class="hash-link" aria-label="Direct link to 三、free_irq函数" title="Direct link to 三、free_irq函数">​</a></h3>
<p>使用中断时候request，同理使用完后，就要free掉，函数原型：</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">void free_irq(unsigned int irq, void *dev)</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中：</p>
<ul>
<li>irq:要释放的中断</li>
<li>dev：设备</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="四中断处理函数">四、中断处理函数<a href="#四中断处理函数" class="hash-link" aria-label="Direct link to 四、中断处理函数" title="Direct link to 四、中断处理函数">​</a></h3>
<p>在使用request_irq的时候，有一个参数是中断处理函数，格式如下：
<code>irqreturn_t (*irq_handler_t)(int, void*)</code>
其中，第一个参数是中断号，第二个函数是通用指针，通常和request_irq函数中的dev参数保持一致，返回类型是irqreturn_t，这是一个枚举类型，如下：</p>
<div class="codeBlockContainer_v3UO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_ycsX"><pre tabindex="0" class="prism-code language-text codeBlock_eS68 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_hVnV"><span class="token-line" style="color:#393A34"><span class="token plain">enum irqreturn {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IRQ_NONE = (0 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IRQ_HANDLED = (1 &lt;&lt; 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IRQ_WAKE_THREAD = (1 &lt;&lt; 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup_tWxT"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_isEe" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_vCuH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon__Hal"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="五中断使能与禁止">五、中断使能与禁止<a href="#五中断使能与禁止" class="hash-link" aria-label="Direct link to 五、中断使能与禁止" title="Direct link to 五、中断使能与禁止">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="使能">使能<a href="#使能" class="hash-link" aria-label="Direct link to 使能" title="Direct link to 使能">​</a></h4>
<p><code>void enable_irq(unsigned int irq)</code></p>
<h4 class="anchor anchorWithStickyNavbar_WC8U" id="禁止">禁止<a href="#禁止" class="hash-link" aria-label="Direct link to 禁止" title="Direct link to 禁止">​</a></h4>
<p><code>void disable_irq(unsigned int ir)</code></p>
<p>其中，禁止函数要等到当前在执行的中断处理函数执行完才返回，因此要保证不会产生新的中断，并确保所有已经开始执行的中断处理函数全部退出，在这种情况下有另一种禁止函数：
<code>void disable_irq_nosync(unsigned int irq)</code></p>
<p>若需要关闭或者使能全部的中断系统，则使用：</p>
<p><code>local_irq_enable()</code></p>
<p><code>local_irq_disable()</code></p>
<p>但此时有一种情况：如果A任务用local_irq_disable关闭了全局中断10s,当运行第二秒的时候，B任务也用了下local_irq_disable， 关闭全局中断3s,3秒以后B任务又使用了local_irq_enable函数打开全局中断，此使刚过去5秒，但是中断被打开了，所以为了避免这种情况，B任务不能粗暴的直接local_irq_enable，而是应该将中断状态恢复到之前的状态，这时候就要用：</p>
<p><code>local_irq_save(flags)</code></p>
<p><code>local_irq_restore(flags)</code></p>
<h2 class="anchor anchorWithStickyNavbar_WC8U" id="上半部与下半部">上半部与下半部<a href="#上半部与下半部" class="hash-link" aria-label="Direct link to 上半部与下半部" title="Direct link to 上半部与下半部">​</a></h2>
<p>对于中断处理函数来说，我们尽可能要运行时间短，不在中断中处理过多的任务，然而可能在实际使用时，无法避免这些问题，因此引入了一个上半部和下半部的概念。
在上半部处理一些简单、时间短的任务，比如初始化啊之类的，把耗时间的任务放到下半部就处理。
操作系统在执行处理函数时，会执行完上半部后，就返回，然后系统在调度中在去执行下半部的部分。</p>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="上半部">上半部<a href="#上半部" class="hash-link" aria-label="Direct link to 上半部" title="Direct link to 上半部">​</a></h3>
<p>写在中断处理函数里的任务就是上半部</p>
<h3 class="anchor anchorWithStickyNavbar_WC8U" id="下半部">下半部<a href="#下半部" class="hash-link" aria-label="Direct link to 下半部" title="Direct link to 下半部">​</a></h3>
<p>实现下半部的方法有以下：</p>
<ul>
<li>softirq :软中断</li>
<li>tasklet :是将下半部通过一个结构体去管理，然后将该结构体放入内核提供的一个链表中，系统去调度，tasklet中的方法不能休眠，运行在中断上下文</li>
<li>workqueue : 是将下半部通过一个结构体去管理，然后将结构体放入到内核提供的一个队列中，系统去调度，同时workqueue其中的方法可  以休眠，运行在线程上下文</li>
</ul>
<h4></h4></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Linux/Imx6ull/imx6ull_uboot_kernel/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">u-boot &amp; kernel</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Linux/CPU Context/cou_context"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CPU Context</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_KLHw thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#中断" class="table-of-contents__link toc-highlight">中断</a><ul><li><a href="#几个概念" class="table-of-contents__link toc-highlight">几个概念</a></li><li><a href="#arm下中断" class="table-of-contents__link toc-highlight">arm下中断</a></li><li><a href="#gic控制器中断流程" class="table-of-contents__link toc-highlight">GIC控制器中断流程</a></li></ul></li><li><a href="#linux中的中断api函数" class="table-of-contents__link toc-highlight">Linux中的中断API函数</a><ul><li><a href="#一中断号" class="table-of-contents__link toc-highlight">一、中断号</a></li><li><a href="#二request_irq函数" class="table-of-contents__link toc-highlight">二、request_irq函数</a></li><li><a href="#三free_irq函数" class="table-of-contents__link toc-highlight">三、free_irq函数</a></li><li><a href="#四中断处理函数" class="table-of-contents__link toc-highlight">四、中断处理函数</a></li><li><a href="#五中断使能与禁止" class="table-of-contents__link toc-highlight">五、中断使能与禁止</a></li></ul></li><li><a href="#上半部与下半部" class="table-of-contents__link toc-highlight">上半部与下半部</a><ul><li><a href="#上半部" class="table-of-contents__link toc-highlight">上半部</a></li><li><a href="#下半部" class="table-of-contents__link toc-highlight">下半部</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Partner Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.yltzdhbc.top/" target="_blank" rel="noopener noreferrer" class="footer__link-item">flame.yu<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_vnGv"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://disnox.top/" target="_blank" rel="noopener noreferrer" class="footer__link-item">苏工<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_vnGv"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Blog</a></li><li class="footer__item"><a href="https://github.com/ljyws" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_vnGv"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>